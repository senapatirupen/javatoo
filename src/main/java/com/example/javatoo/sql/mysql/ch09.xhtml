<!DOCTYPE html>
<html lang="en" xml:lang="en" xmlns="http://www.w3.org/1999/xhtml" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.w3.org/2002/06/xhtml2/ http://www.w3.org/MarkUp/SCHEMA/xhtml2.xsd" xmlns:epub="http://www.idpf.org/2007/ops">
<head>
<link href="Styles/Style00.css" rel="stylesheet" type="text/css" />
<link href="Styles/Style01.css" rel="stylesheet" type="text/css" />

<style type="text/css">body{margin:1em;background-color:transparent!important;}#sbo-rt-content *{text-indent:0pt!important;}#sbo-rt-content .bq{margin-right:1em!important;}#sbo-rt-content *{word-wrap:break-word!important;word-break:break-word!important;}#sbo-rt-content table,#sbo-rt-content pre{overflow-x:unset!important;overflow:unset!important;overflow-y:unset!important;white-space:pre-wrap!important;}</style></head>
<body><div id="sbo-rt-content"><section data-type="chapter" epub:type="chapter" data-pdf-bookmark="Chapter 9. Mastering MySQL"><div class="chapter" id="mastering_mysql">
<h1><span class="label">Chapter 9. </span>Mastering MySQL</h1>

<aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="idm45310005580072"><h5>A note for Early Release readers</h5>
<p>With Early Release ebooks, you get books in their earliest form—the author’s raw and unedited content as they write—so you can take advantage of these technologies long before the official release of these titles.</p>

<p>This will be the 9th chapter of the final book. Please note that the GitHub repo will be made active later on.</p>

<p>If you have comments about how we might improve the content and/or examples in this book, or if you notice missing material within this chapter, please reach out to the author at mpotter@oreilly.com.</p>
</div></aside>

<p><a data-type="xref" href="ch08.xhtml#introduction_to_mysql">Chapter 8</a> provided you with a good grounding in the practice of using relational databases with the Structured Query Language. You’ve learned about creating databases and the tables they comprise, as well as inserting, looking up, changing, and deleting data.</p>

<p>With that knowledge under your belt, we now need to look at how to design databases for maximum speed and efficiency. For example, how do you decide what data to place in which table? Well, over the years, a number of guidelines have been developed that—if you follow them—ensure that your databases will be efficient and capable of growing as you feed them more and more data.</p>

<section data-type="sect1" data-pdf-bookmark="Database Design"><div class="sect1" id="database_design">
<h1>Database Design</h1>

<p>It’s<a contenteditable="false" data-primary="MySQL" data-secondary="database design considerations" data-type="indexterm" id="idm45310005573160"/><a contenteditable="false" data-primary="databases" data-secondary="design considerations" data-type="indexterm" id="idm45310005571688"/> very important that you design a database correctly before you start to create it; otherwise, you are almost certainly going to have to go back and change it by splitting up some tables, merging others, and moving various columns about in order to achieve sensible relationships that MySQL can easily use.</p>

<p>Sitting down with a sheet of paper and a pencil and writing down a selection of the queries that you think you and your users are likely to ask is an excellent starting point. In the case of an online bookstore’s database, some of your questions could be:</p>

<ul>
	<li>
	<p>How many authors, books, and customers are in the database?</p>
	</li>
	<li>
	<p>Which author wrote a certain book?</p>
	</li>
	<li>
	<p>Which books were written by a certain author?</p>
	</li>
	<li>
	<p>What is the most expensive book?</p>
	</li>
	<li>
	<p>What is the best-selling book?</p>
	</li>
	<li>
	<p>Which books have not sold this year?</p>
	</li>
	<li>
	<p>Which books did a certain customer buy?</p>
	</li>
	<li>
	<p>Which books have been purchased along with the same other books?</p>
	</li>
</ul>

<p>Of course, there are many more queries that you could make on such a database, but even this small sample will begin to give you insights into how to lay out your tables. For example, books and ISBNs can probably be combined into one table, because they are closely linked (we’ll examine some of the subtleties later). In contrast, books and customers should be in separate tables, because their connection is very loose. A customer can buy any book, and even multiple copies of a book, yet a book can be bought by many customers and be ignored by still more potential customers.</p>

<p>When you plan to do a lot of searches on something, it can often benefit by having its own table. And when couplings between things are loose, it’s best to put them in separate tables.</p>

<p>Taking into account those simple rules of thumb, we can guess we’ll need at least three tables to accommodate all these queries:</p>

<dl>
	<dt><dfn>Authors</dfn></dt>
	<dd>
	<p>There will be lots of searches for authors, many of whom have collaborated on titles, and many of whom will be featured in collections. Listing all the information about each author together, linked to that author, will produce optimal results for searches—hence an <em>Authors</em> table.</p>
	</dd>
	<dt><dfn>Books</dfn></dt>
	<dd>
	<p>Many books appear in different editions. Sometimes they change publisher and sometimes they have the same titles as other, unrelated books. So, the links between books and authors are complicated enough to call for a separate table.</p>
	</dd>
	<dt><dfn>Customers</dfn></dt>
	<dd>
	<p>It’s even more clear why customers should get their own table, as they are free to purchase any book by any author.</p>
	</dd>
</dl>

<section data-type="sect2" data-pdf-bookmark="Primary Keys: The Keys to Relational Databases"><div class="sect2" id="primary_keys_the_keys_to_relational_data">
<h2>Primary Keys: The Keys to Relational Databases</h2>

<p>Using<a contenteditable="false" data-primary="MySQL" data-secondary="primary keys in" data-type="indexterm" id="idm45310005551368"/><a contenteditable="false" data-primary="primary keys" data-type="indexterm" id="idm45310005549960"/><a contenteditable="false" data-primary="databases" data-secondary="primary keys in" data-type="indexterm" id="idm45310005548856"/><a contenteditable="false" data-primary="keys (MySQL)" data-type="indexterm" id="idm45310005547720"/> the power of relational databases, we can define information for each author, book, and customer in just one place. Obviously, what interests us is the links between them—such as who wrote each book and who purchased it—but we can store that information just by making links between the three tables. I’ll show you the basic principles, and then it just takes practice for it to feel natural.</p>

<p>The magic involves giving every author a unique identifier. We’ll do the same for every book and for every customer. We saw the means of doing that in the previous chapter: the <em>primary key</em>. For a book, it makes sense to use the ISBN, although you then have to deal with multiple editions that have different ISBNs. For authors and customers, you can just assign arbitrary keys, which the <code>AUTO_INCREMENT</code> feature that you saw in the last chapter makes easy.</p>

<p>In short, every table will be designed around some object that you’re likely to search for a lot—an author, book, or customer, in this case—and that object will have a primary key. Don’t choose a key that could possibly have the same value for different objects. The ISBN is a rare case for which an industry has provided a primary key that you can rely on to be unique for each product. Most of the time, you’ll create an arbitrary key for this purpose, using <code>AUTO_INCREMENT</code>.</p>
</div></section>
</div></section>

<section data-type="sect1" data-pdf-bookmark="Normalization"><div class="sect1" id="normalization">
<h1>Normalization</h1>

<p>The<a contenteditable="false" data-primary="MySQL" data-secondary="normalization process" data-type="indexterm" id="MSQnomal09"/><a contenteditable="false" data-primary="databases" data-secondary="normalization process" data-type="indexterm" id="Dnormaal09"/><a contenteditable="false" data-primary="normalization process" data-secondary="goal of" data-type="indexterm" id="idm45310005538184"/> process of separating your data into tables and creating primary keys is called <em>normalization</em>. Its main goal is to make sure each piece of information appears in the database only once. Duplicating data is inefficient, because it makes databases larger than they need to be and therefore slows access. More importantly, the presence of duplicates creates a strong risk that you’ll update only one row of duplicated data, creating inconsistencies in a database and potentially causing serious errors.</p>

<p>For example, if you list the titles of books in the <em>Authors</em> table as well as the <em>Books</em> table, and you have to correct a typographic error in a title, you’ll have to search through both tables and make sure you make the same change every place the title is listed. It’s better to keep the title in one place and use the ISBN in other places.</p>

<p>But in the process of splitting a database into multiple tables, it’s important not to go too far and create more tables than is necessary, which would also lead to inefficient design and slower access.</p>

<p>Luckily, E. F. Codd, the inventor<a contenteditable="false" data-primary="normalization process" data-secondary="schemas for" data-type="indexterm" id="idm45310005533064"/> of the relational model, analyzed the concept of normalization and split it into three separate schemas called <em>First</em>, <em>Second</em>, and <em>Third Normal Form</em>. If you modify a database to satisfy each of these forms in order, you will ensure that your database is optimally balanced for fast access and minimum memory and disk space usage.</p>

<p>To see how the normalization process works, let’s start with the rather monstrous database in <a data-type="xref" href="#highly_inefficient_design_for_a_databa">Table 9-1</a>, which shows a single table containing all of the author names, book titles, and (fictional) customer details. You could consider it a first attempt at a table intended to keep track of which customers have ordered books. Obviously this is an inefficient design, because data is duplicated all over the place (duplications are highlighted), but it represents a starting point.</p>

<table id="highly_inefficient_design_for_a_databa">
	<caption><span class="label">Table 9-1. </span>A highly inefficient design for a database table</caption>
	<thead>
		<tr>
			<th>Author 1</th>
			<th>Author 2</th>
			<th>Title</th>
			<th>ISBN</th>
			<th>Price</th>
			<th>Customer name</th>
			<th>Customer address</th>
			<th>Purchase date</th>
		</tr>
	</thead>
	<tbody>
		<tr>
			<td><em>David Sklar</em></td>
			<td><em>Adam Trachtenberg</em></td>
			<td><em>PHP Cookbook</em></td>
			<td><em>0596101015</em></td>
			<td><em>44.99</em></td>
			<td>Emma Brown</td>
			<td>1565 Rainbow Road, Los Angeles, CA 90014</td>
			<td>Mar 03 2009</td>
		</tr>
		<tr>
			<td>Danny Goodman</td>
			<td> </td>
			<td>Dynamic HTML</td>
			<td>0596527403</td>
			<td>59.99</td>
			<td><strong>Darren Ryder</strong></td>
			<td><strong>4758 Emily Drive, Richmond, VA 23219</strong></td>
			<td><strong>Dec 19 2008</strong></td>
		</tr>
		<tr>
			<td>Hugh E. Williams</td>
			<td>David Lane</td>
			<td>PHP and MySQL</td>
			<td>0596005436</td>
			<td>44.95</td>
			<td>Earl B. Thurston</td>
			<td>862 Gregory Lane, Frankfort, KY 40601</td>
			<td>Jun 22 2009</td>
		</tr>
		<tr>
			<td><em>David Sklar</em></td>
			<td><em>Adam Trachtenberg</em></td>
			<td><em>PHP Cookbook</em></td>
			<td><em>0596101015</em></td>
			<td><em>44.99</em></td>
			<td><strong>Darren Ryder</strong></td>
			<td><strong>4758 Emily Drive, Richmond, VA 23219</strong></td>
			<td><strong>Dec 19 2008</strong></td>
		</tr>
		<tr>
			<td>Rasmus Lerdorf</td>
			<td>Kevin Tatroe &amp; Peter MacIntyre</td>
			<td>Programming PHP</td>
			<td>0596006815</td>
			<td>39.99</td>
			<td>David Miller</td>
			<td>3647 Cedar Lane, Waltham, MA 02154</td>
			<td>Jan 16 2009</td>
		</tr>
	</tbody>
</table>

<p>In the following three sections, we will examine this database design, and you’ll see how we can improve it by removing the various duplicate entries and splitting the single table into multiple tables, each containing one type of data.</p>

<section data-type="sect2" data-pdf-bookmark="First Normal Form"><div class="sect2" id="first_normal_form">
<h2>First Normal Form</h2>

<p>For<a contenteditable="false" data-primary="normalization process" data-secondary="First Normal Form" data-type="indexterm" id="idm45310005496408"/> a database to satisfy the <em>First Normal Form</em>, it must fulfill three requirements:</p>

<ul>
	<li>
	<p>There should be no repeating columns containing the same kind of data.</p>
	</li>
	<li>
	<p>All columns should contain a single value.</p>
	</li>
	<li>
	<p>There should be a primary key to uniquely identify each row.</p>
	</li>
</ul>

<p>Looking at these requirements in order, you should notice straightaway that both the <em>Author 1</em> and <em>Author 2</em> columns constitute repeating data types. So we already have a target column for pulling into a separate table, as the repeated <em>Author</em> columns violate Rule 1.</p>

<p>Second, there are three authors listed for the final book, <em>Programming PHP</em>. I’ve handled that by making Kevin Tatroe and Peter MacIntyre share the <em>Author 2</em> column, which violates Rule 2—yet another reason to transfer the <em>Author</em> details to a separate table.</p>

<p>However, Rule 3 is satisfied, because the primary key of ISBN has already been created.</p>

<p><a data-type="xref" href="#result_of_stripping_the_authors_colu">Table 9-2</a> shows the result of removing the <em>Author</em> columns from <a data-type="xref" href="#highly_inefficient_design_for_a_databa">Table 9-1</a>. Already it looks a lot less cluttered, although there remain duplications that are highlighted.</p>

<table id="result_of_stripping_the_authors_colu">
	<caption><span class="label">Table 9-2. </span>The result of stripping the Author columns from <a data-type="xref" href="#highly_inefficient_design_for_a_databa">Table 9-1</a></caption>
	<thead>
		<tr>
			<th>Title</th>
			<th>ISBN</th>
			<th>Price</th>
			<th>Customer name</th>
			<th>Customer address</th>
			<th>Purchase date</th>
		</tr>
	</thead>
	<tbody>
		<tr>
			<td><em>PHP Cookbook</em></td>
			<td><em>0596101015</em></td>
			<td><em>44.99</em></td>
			<td>Emma Brown</td>
			<td>1565 Rainbow Road, Los Angeles, CA 90014</td>
			<td>Mar 03 2009</td>
		</tr>
		<tr>
			<td>Dynamic HTML</td>
			<td>0596527403</td>
			<td>59.99</td>
			<td><strong>Darren Ryder</strong></td>
			<td><strong>4758 Emily Drive, Richmond, VA 23219</strong></td>
			<td><strong>Dec 19 2008</strong></td>
		</tr>
		<tr>
			<td>PHP and MySQL</td>
			<td>0596005436</td>
			<td>44.95</td>
			<td>Earl B. Thurston</td>
			<td>862 Gregory Lane, Frankfort, KY 40601</td>
			<td>Jun 22 2009</td>
		</tr>
		<tr>
			<td><em>PHP Cookbook</em></td>
			<td><em>0596101015</em></td>
			<td><em>44.99</em></td>
			<td><strong>Darren Ryder</strong></td>
			<td><strong>4758 Emily Drive, Richmond, VA 23219</strong></td>
			<td><strong>Dec 19 2008</strong></td>
		</tr>
		<tr>
			<td>Programming PHP</td>
			<td>0596006815</td>
			<td>39.99</td>
			<td>David Miller</td>
			<td>3647 Cedar Lane, Waltham, MA 02154</td>
			<td>Jan 16 2009</td>
		</tr>
	</tbody>
</table>

<p>The new <em>Authors</em> table shown in <a data-type="xref" href="#new_authors_table">Table 9-3</a> is small and simple. It just lists the ISBN of a title along with an author. If a title has more than one author, additional authors get their own rows. At first, you may feel ill at ease with this table, because you can’t tell which author wrote which book. But don’t worry: MySQL can quickly tell you. All you have to do is tell it which book you want information for, and MySQL will use its ISBN to search the <em>Authors</em> table in a matter of milliseconds.</p>

<table id="new_authors_table">
	<caption class="width-full"><span class="label">Table 9-3. </span>The new Authors table</caption>
	<thead>
		<tr>
			<th>ISBN</th>
			<th>Author</th>
		</tr>
	</thead>
	<tbody>
		<tr>
			<td>0596101015</td>
			<td>David Sklar</td>
		</tr>
		<tr>
			<td>0596101015</td>
			<td>Adam Trachtenberg</td>
		</tr>
		<tr>
			<td>0596527403</td>
			<td>Danny Goodman</td>
		</tr>
		<tr>
			<td>0596005436</td>
			<td>Hugh E. Williams</td>
		</tr>
		<tr>
			<td>0596005436</td>
			<td>David Lane</td>
		</tr>
		<tr>
			<td>0596006815</td>
			<td>Rasmus Lerdorf</td>
		</tr>
		<tr>
			<td>0596006815</td>
			<td>Kevin Tatroe</td>
		</tr>
		<tr>
			<td>0596006815</td>
			<td>Peter MacIntyre</td>
		</tr>
	</tbody>
</table>

<p>As I mentioned earlier, the ISBN will be the primary key for the <em>Books</em> table, when we get around to creating that table. I mention that here in order to emphasize that the ISBN is not, however, the primary key for the <em>Authors</em> table. In the real world, the <em>Authors</em> table would deserve a primary key, too, so that each author would have a key to uniquely identify them.</p>

<p>So, in the <em>Authors</em> table, <em>ISBN</em> is just a column that—for the purposes of speeding up searches—we’ll probably make a key, but not the primary key. In fact, it <em>cannot</em> be the primary key in this table, because it’s not unique: the same ISBN appears multiple times whenever two or more authors have collaborated on a book.</p>

<p>Because we’ll use it to link authors to books in another table, this column is called a <em>foreign</em> key.</p>

<div data-type="note" epub:type="note"><h6>Note</h6>
<p>Keys (also called <em>indexes</em>) have several purposes in MySQL. The fundamental reason for defining a key is to make searches faster. You’ve seen examples in <a data-type="xref" href="ch08.xhtml#introduction_to_mysql">Chapter 8</a> in which keys are used in <code>WHERE</code> clauses for searching. But a key can also be useful to uniquely identify an item. Thus, a unique key is often used as a primary key in one table, and as a foreign key to link rows in that table to rows in another table.</p>
</div>
</div></section>

<section data-type="sect2" data-pdf-bookmark="Second Normal Form"><div class="sect2" id="second_normal_form">
<h2>Second Normal Form</h2>

<p>The<a contenteditable="false" data-primary="normalization process" data-secondary="Second Normal Form" data-type="indexterm" id="NPsecond09"/> First Normal Form deals with duplicate data (or redundancy) across multiple columns. The <em>Second Normal Form</em> is all about redundancy across multiple rows. To achieve Second Normal Form, your tables must already be in First Normal Form. Once this has been done, you achieve Second Normal Form by identifying columns whose data repeats in different places and then removing them to their own tables.</p>

<p>So, let’s look again at <a data-type="xref" href="#result_of_stripping_the_authors_colu">Table 9-2</a>. Notice how Darren Ryder bought two books and therefore his details are duplicated. This tells us that the <em>Customer</em> columns need to be pulled into their own table. <a data-type="xref" href="#new_titles_table">Table 9-4</a> shows the result of removing the <em>Customer</em> columns from <a data-type="xref" href="#result_of_stripping_the_authors_colu">Table 9-2</a>.</p>

<table id="new_titles_table">
	<caption><span class="label">Table 9-4. </span>The new Titles table</caption>
	<thead>
		<tr>
			<th>ISBN</th>
			<th>Title</th>
			<th>Price</th>
		</tr>
	</thead>
	<tbody>
		<tr>
			<td>0596101015</td>
			<td>PHP Cookbook</td>
			<td>44.99</td>
		</tr>
		<tr>
			<td>0596527403</td>
			<td>Dynamic HTML</td>
			<td>59.99</td>
		</tr>
		<tr>
			<td>0596005436</td>
			<td>PHP and MySQL</td>
			<td>44.95</td>
		</tr>
		<tr>
			<td>0596006815</td>
			<td>Programming PHP</td>
			<td>39.99</td>
		</tr>
	</tbody>
</table>

<p>As you can see, all that’s left in <a data-type="xref" href="#new_titles_table">Table 9-4</a> are the <em>ISBN</em>, <em>Title</em>, and <em>Price</em> columns for four unique books, so this now constitutes an efficient and self-contained table that satisfies the requirements of both the First and Second Normal Forms. Along the way, we’ve managed to reduce the information to data closely related to book titles. This table could also include years of publication, page counts, numbers of reprints, and so on, as these details are also closely related. The only rule is that we can’t put in any column that could have multiple values for a single book, because then we’d have to list the same book in multiple rows and would thus violate Second Normal Form. Restoring an <em>Author</em> column, for instance, would violate this normalization.</p>

<p>However, looking at the extracted <em>Customer</em> columns, now in <a data-type="xref" href="#customer_details_from_table_9-2">Table 9-5</a>, we can see that there’s still more normalization work to do, because Darren Ryder’s details are still duplicated. And it could also be argued that First Normal Form Rule 2 (all columns should contain a single value) has not been properly complied with, because the addresses really need to be broken into separate columns for <em>Address</em>, <em>City</em>, <em>State</em>, and <em>Zip</em>.</p>

<table id="customer_details_from_table_9-2">
	<caption><span class="label">Table 9-5. </span>The customer details from <a data-type="xref" href="#result_of_stripping_the_authors_colu">Table 9-2</a></caption>
	<thead>
		<tr>
			<th>ISBN</th>
			<th>Customer name</th>
			<th>Customer address</th>
			<th>Purchase date</th>
		</tr>
	</thead>
	<tbody>
		<tr>
			<td>0596101015</td>
			<td>Emma Brown</td>
			<td>1565 Rainbow Road, Los Angeles, CA 90014</td>
			<td>Mar 03 2009</td>
		</tr>
		<tr>
			<td>0596527403</td>
			<td>Darren Ryder</td>
			<td>4758 Emily Drive, Richmond, VA 23219</td>
			<td>Dec 19 2008</td>
		</tr>
		<tr>
			<td>0596005436</td>
			<td>Earl B. Thurston</td>
			<td>862 Gregory Lane, Frankfort, KY 40601</td>
			<td>Jun 22 2009</td>
		</tr>
		<tr>
			<td>0596101015</td>
			<td>Darren Ryder</td>
			<td>4758 Emily Drive, Richmond, VA 23219</td>
			<td>Dec 19 2008</td>
		</tr>
		<tr>
			<td>0596006815</td>
			<td>David Miller</td>
			<td>3647 Cedar Lane, Waltham, MA 02154</td>
			<td>Jan 16 2009</td>
		</tr>
	</tbody>
</table>

<p>What we have to do is split this table further to ensure that each customer’s details are entered only once. Because the ISBN is not and cannot be used as a primary key to identify customers (or authors), a new key must be created.</p>

<p><a data-type="xref" href="#new_customers_table">Table 9-6</a> is the result of normalizing the <em>Customers</em> table into both First and Second Normal Forms. Each customer now has a unique customer number called <em>CustNo</em> that is the table’s primary key, and that will most likely have been created via <code>AUTO_INCREMENT</code>. All the parts of customer addresses have also been separated into distinct columns to make them easily searchable and updateable.</p>

<table id="new_customers_table">
	<caption><span class="label">Table 9-6. </span>The new Customers table</caption>
	<thead>
		<tr>
			<th>CustNo</th>
			<th>Name</th>
			<th>Address</th>
			<th>City</th>
			<th>State</th>
			<th>Zip</th>
		</tr>
	</thead>
	<tbody>
		<tr>
			<td>1</td>
			<td>Emma Brown</td>
			<td>1565 Rainbow Road</td>
			<td>Los Angeles</td>
			<td>CA</td>
			<td>90014</td>
		</tr>
		<tr>
			<td>2</td>
			<td>Darren Ryder</td>
			<td>4758 Emily Drive</td>
			<td>Richmond</td>
			<td>VA</td>
			<td>23219</td>
		</tr>
		<tr>
			<td>3</td>
			<td>Earl B. Thurston</td>
			<td>862 Gregory Lane</td>
			<td>Frankfort</td>
			<td>KY</td>
			<td>40601</td>
		</tr>
		<tr>
			<td>4</td>
			<td>David Miller</td>
			<td>3647 Cedar Lane</td>
			<td>Waltham</td>
			<td>MA</td>
			<td>02154</td>
		</tr>
	</tbody>
</table>

<p>At the same time, in order to normalize <a data-type="xref" href="#new_customers_table">Table 9-6</a>, we had to remove the information on customer purchases, because otherwise, there would be multiple instances of customer details for each book purchased. Instead, the purchase data is now placed in a new table called <em>Purchases</em> (see <a data-type="xref" href="#new_purchases_table">Table 9-7</a>).</p>

<table id="new_purchases_table">
	<caption class="width-full"><span class="label">Table 9-7. </span>The new Purchases table</caption>
	<thead>
		<tr>
			<th>CustNo</th>
			<th>ISBN</th>
			<th>Date</th>
		</tr>
	</thead>
	<tbody>
		<tr>
			<td>1</td>
			<td>0596101015</td>
			<td>Mar 03 2009</td>
		</tr>
		<tr>
			<td>2</td>
			<td>0596527403</td>
			<td>Dec 19 2008</td>
		</tr>
		<tr>
			<td>2</td>
			<td>0596101015</td>
			<td>Dec 19 2008</td>
		</tr>
		<tr>
			<td>3</td>
			<td>0596005436</td>
			<td>Jun 22 2009</td>
		</tr>
		<tr>
			<td>4</td>
			<td>0596006815</td>
			<td>Jan 16 2009</td>
		</tr>
	</tbody>
</table>

<p>Here the <em>CustNo</em> column from <a data-type="xref" href="#new_customers_table">Table 9-6</a> is reused as a key to tie the <em>Customers</em> and <em>Purchases</em> tables together. Because the <em>ISBN</em> column is also repeated here, this table can be linked with the <em>Authors</em> and <em>Titles</em> tables, too.</p>

<p>The <em>CustNo</em> column may be a useful key in the <em>Purchases</em> table, but it’s not a primary key. A single customer can buy multiple books (and even multiple copies of one book), so the <em>CustNo</em> column is not a primary key. In fact, the <em>Purchases</em> table has no primary key. That’s all right, because we don’t expect to need to keep track of unique purchases. If one customer buys two copies of the same book on the same day, we’ll just allow two rows with the same information. For easy searching, we can define both <em>CustNo</em> and <em>ISBN</em> as keys—just not as primary keys.</p>

<div data-type="note" epub:type="note"><h6>Note</h6>
<p>There are now four tables, one more than the three we had initially assumed would be needed. We arrived at this decision through the normalization process, by methodically following the First and Second Normal Form rules, which made it plain that a fourth table called <em>Purchases</em> would also be required.</p>
</div>

<p>The tables we now have are <em>Authors</em> (<a data-type="xref" href="#new_authors_table">Table 9-3</a>), <em>Titles</em> (<a data-type="xref" href="#new_titles_table">Table 9-4</a>), <em>Customers</em> (<a data-type="xref" href="#new_customers_table">Table 9-6</a>), and <em>Purchases</em> (<a data-type="xref" href="#new_purchases_table">Table 9-7</a>), and we can link each table to any other using either the <em>CustNo</em> or the <em>ISBN</em> key.</p>

<p>For example, to see which books Darren Ryder has purchased, you can look him up in <a data-type="xref" href="#new_customers_table">Table 9-6</a>, the <em>Customers</em> table, where you will see his <em>CustNo</em> is 2. Armed with this number, you can now go to <a data-type="xref" href="#new_purchases_table">Table 9-7</a>, the <em>Purchases</em> table; looking at the <em>ISBN</em> column here, you will see that he purchased titles 0596527403 and 0596101015 on December 19, 2008. This looks like a lot of trouble for a human, but it’s not so hard for MySQL.</p>

<p>To determine what these titles were, you can then refer to <a data-type="xref" href="#new_titles_table">Table 9-4</a>, the <em>Titles</em> table, and see that the books he bought were <em>Dynamic HTML</em> and <em>PHP Cookbook</em>. Should you wish to know the authors of these books, you could also use the ISBNs you just looked up on <a data-type="xref" href="#new_authors_table">Table 9-3</a>, the <em>Authors</em> table, and you would see that ISBN 0596527403, <em>Dynamic HTML</em>, was written by Danny Goodman, and that ISBN 0596101015, <em>PHP Cookbook</em>, was written by David Sklar and Adam Trachtenberg.<a contenteditable="false" data-primary="" data-startref="NPsecond09" data-type="indexterm" id="idm45310005325304"/></p>
</div></section>

<section data-type="sect2" data-pdf-bookmark="Third Normal Form"><div class="sect2" id="third_normal_form">
<h2>Third Normal Form</h2>

<p>Once<a contenteditable="false" data-primary="normalization process" data-secondary="Third Normal Form" data-type="indexterm" id="idm45310005322184"/> you have a database that complies with both the First and Second Normal Forms, it is in pretty good shape and you might not have to modify it any further. However, if you wish to be very strict with your database, you can ensure that it adheres to the <em>Third Normal Form</em>, which requires that data that is <em>not</em> directly dependent on the primary key but <em>is</em> dependent on another value in the table should also be moved into separate tables, according to the dependence.</p>

<p>For example, in <a data-type="xref" href="#new_customers_table">Table 9-6</a>, the <em>Customers</em> table, it could be argued that the <em>State</em>, <em>City</em>, and <em>Zip</em> keys are not directly related to each customer, because many other people will have the same details in their addresses, too. However, they are directly related to each other, in that the <em>Address</em> relies on the <em>City</em>, and the <em>City</em> relies on the <em>State</em>.</p>

<p>Therefore, to satisfy Third Normal Form for <a data-type="xref" href="#new_customers_table">Table 9-6</a>, you would need to split it into Tables <a href="#third_normal_form_customers_table">9–8</a> through <a href="#third_normal_form_states_table">9–11</a>.</p>

<table id="third_normal_form_customers_table">
	<caption class="width-full"><span class="label">Table 9-8. </span>Third Normal Form Customers table</caption>
	<thead>
		<tr>
			<th>CustNo</th>
			<th>Name</th>
			<th>Address</th>
			<th>Zip</th>
		</tr>
	</thead>
	<tbody>
		<tr>
			<td>1</td>
			<td>Emma Brown</td>
			<td>1565 Rainbow Road</td>
			<td>90014</td>
		</tr>
		<tr>
			<td>2</td>
			<td>Darren Ryder</td>
			<td>4758 Emily Drive</td>
			<td>23219</td>
		</tr>
		<tr>
			<td>3</td>
			<td>Earl B. Thurston</td>
			<td>862 Gregory Lane</td>
			<td>40601</td>
		</tr>
		<tr>
			<td>4</td>
			<td>David Miller</td>
			<td>3647 Cedar Lane</td>
			<td>02154</td>
		</tr>
	</tbody>
</table>

<table id="third_normal_form_zip_codes_table">
	<caption class="width-full"><span class="label">Table 9-9. </span><br/>
	Third Normal Form Zip codes table</caption>
	<thead>
		<tr>
			<th>Zip</th>
			<th>CityID</th>
		</tr>
	</thead>
	<tbody>
		<tr>
			<td>90014</td>
			<td>1234</td>
		</tr>
		<tr>
			<td>23219</td>
			<td>5678</td>
		</tr>
		<tr>
			<td>40601</td>
			<td>4321</td>
		</tr>
		<tr>
			<td>02154</td>
			<td>8765</td>
		</tr>
	</tbody>
</table>

<table id="third_normal_form_cities_table">
	<caption class="width-full"><span class="label">Table 9-10. </span><br/>
	Third Normal Form Cities table</caption>
	<thead>
		<tr>
			<th>CityID</th>
			<th>Name</th>
			<th>StateID</th>
		</tr>
	</thead>
	<tbody>
		<tr>
			<td>1234</td>
			<td>Los Angeles</td>
			<td>5</td>
		</tr>
		<tr>
			<td>5678</td>
			<td>Richmond</td>
			<td>46</td>
		</tr>
		<tr>
			<td>4321</td>
			<td>Frankfort</td>
			<td>17</td>
		</tr>
		<tr>
			<td>8765</td>
			<td>Waltham</td>
			<td>21</td>
		</tr>
	</tbody>
</table>

<table id="third_normal_form_states_table">
	<caption class="width-full"><span class="label">Table 9-11. </span><br/>
	Third Normal Form States table</caption>
	<thead>
		<tr>
			<th>StateID</th>
			<th>Name</th>
			<th>Abbreviation</th>
		</tr>
	</thead>
	<tbody>
		<tr>
			<td>5</td>
			<td>California</td>
			<td>CA</td>
		</tr>
		<tr>
			<td>46</td>
			<td>Virginia</td>
			<td>VA</td>
		</tr>
		<tr>
			<td>17</td>
			<td>Kentucky</td>
			<td>KY</td>
		</tr>
		<tr>
			<td>21</td>
			<td>Massachusetts</td>
			<td>MA</td>
		</tr>
	</tbody>
</table>

<p>So, how would you use this set of four tables instead of the single <a data-type="xref" href="#new_customers_table">Table 9-6</a>? Well, you would look up the <em>Zip</em> <em>code</em> in <a data-type="xref" href="#third_normal_form_customers_table">Table 9-8</a>, and then find the matching <em>CityID</em> in <a data-type="xref" href="#third_normal_form_zip_codes_table">Table 9-9</a>. Given this information, you could look up the city <em>Name</em> in <a data-type="xref" href="#third_normal_form_cities_table">Table 9-10</a> and then also find the <em>StateID</em>, which you could use in <a data-type="xref" href="#third_normal_form_states_table">Table 9-11</a> to look up the state’s <em>Name</em>.</p>

<p>Although using the Third Normal Form in this way may seem like overkill, it can have advantages. For example, take a look at <a data-type="xref" href="#third_normal_form_states_table">Table 9-11</a>, where it has been possible to include both a state’s name and its two-letter abbreviation. It could also contain population details and other demographics, if you desired.</p>

<div data-type="note" epub:type="note"><h6>Note</h6>
<p><a data-type="xref" href="#third_normal_form_cities_table">Table 9-10</a> could also contain even more localized demographics that could be useful to you and/or your customers. By splitting up these pieces of data, you can make it easier to maintain your database in the future, should it be necessary to add columns.</p>
</div>

<p>Deciding whether to use the Third Normal Form can be tricky. Your evaluation should rest on what data you may need to add at a later date. If you are absolutely certain that the name and address of a customer is all that you will ever require, you probably will want to leave out this final normalization stage.</p>

<p>On the other hand, suppose you are writing a database for a large organization such as the US Postal Service. What would you do if a city were to be renamed? With a table such as <a data-type="xref" href="#new_customers_table">Table 9-6</a>, you would need to perform a global search-and-replace on every instance of that city. But if you have your database set up according to the Third Normal Form, you would have to change only a single entry in <a data-type="xref" href="#third_normal_form_cities_table">Table 9-10</a> for the change to be reflected throughout the entire database.</p>

<p>Therefore, I suggest that you ask yourself two questions to help you decide whether to perform a Third Normal Form normalization on any table:</p>

<ul>
	<li>
	<p>Is it likely that many new columns will need to be added to this table?</p>
	</li>
	<li>
	<p>Could any of this table’s fields require a global update at any point?</p>
	</li>
</ul>

<p>If either of the answers is yes, you should probably consider performing this final stage of normalization.</p>
</div></section>

<section data-type="sect2" data-pdf-bookmark="When Not to Use Normalization"><div class="sect2" id="when_not_to_use_normalization">
<h2>When Not to Use Normalization</h2>

<p>Now<a contenteditable="false" data-primary="normalization process" data-secondary="appropriate use of" data-type="indexterm" id="idm45310005244264"/> that you know all about normalization, I’m going to tell you why you should throw these rules out of the window on high-traffic sites. That’s right—you should never fully normalize your tables on sites that will cause MySQL to thrash.</p>

<p>Normalization requires spreading data across multiple tables, and this means making multiple calls to MySQL for each query. On a very popular site, if you have normalized tables, your database access will slow down considerably once you get above a few dozen concurrent users, because they will be creating hundreds of database accesses between them. In fact, I would go so far as to say you should <em>denormalize</em> any commonly looked-up data as much as you can.</p>

<p>You see, if you have data duplicated across your tables, you can substantially reduce the number of additional requests that need to be made, because most of the data you want is available in each table. This means that you can simply add an extra column to a query and that field will be available for all matching results.</p>

<p>Of course, you have to deal with the downsides previously mentioned, such as using up large amounts of disk space, and ensuring that you update every single duplicate copy of the data when it needs modifying.</p>

<p>Multiple updates can be computerized, though. MySQL provides a feature called <em>triggers</em> that make automatic changes to the database in response to changes you make. (Triggers are, however, beyond the scope of this book.) Another way to propagate redundant data is to set up a PHP program to run regularly and keep all copies in sync. The program reads changes from a “master” table and updates all the others. (You’ll see how to access MySQL from PHP in the next chapter.)</p>

<p>However, until you are very experienced with MySQL, I recommend that you fully normalize all your tables (at least to First and Second Normal Form), as this will instil the habit and put you in good stead. Only when you actually start to see MySQL logjams should you consider looking at denormalization.<a contenteditable="false" data-primary="" data-startref="MSQnomal09" data-type="indexterm" id="idm45310005237864"/><a contenteditable="false" data-primary="" data-startref="Dnormaal09" data-type="indexterm" id="idm45310005236488"/></p>
</div></section>
</div></section>

<section data-type="sect1" data-pdf-bookmark="Relationships"><div class="sect1" id="relationships">
<h1>Relationships</h1>

<p>MySQL<a contenteditable="false" data-primary="MySQL" data-secondary="relationships in" data-type="indexterm" id="MSQrelat09"/><a contenteditable="false" data-primary="databases" data-secondary="relationships in" data-type="indexterm" id="DBrelat09"/> is called a <em>relational</em> database management system because its tables store not only data but the <em>relationships</em> among the data. There are three categories of relationships.</p>

<section data-type="sect2" data-pdf-bookmark="One-to-One"><div class="sect2" id="one-to-one">
<h2>One-to-One</h2>

<p>A <em>one-to-one relationship</em> is<a contenteditable="false" data-primary="relationships, in databases" data-secondary="one-to-one relationship" data-type="indexterm" id="idm45310005226584"/><a contenteditable="false" data-primary="one-to-one relationship" data-type="indexterm" id="idm45310005225112"/> like a (traditional) marriage: each item has a relationship to only one item of the other type. This is surprisingly rare. For instance, an author can write multiple books, a book can have multiple authors, and even an address can be associated with multiple customers. Perhaps the best example in this chapter so far of a one-to-one relationship is the relationship between the name of a state and its two-character abbreviation.</p>

<p>However, for the sake of argument, let’s assume that there can always be only one customer at any address. In such a case, the Customers–Addresses relationship in <a data-type="xref" href="#customers_tablecomma_table_9-8comma">Figure 9-1</a> is a one-to-one relationship: only one customer lives at each address, and each address can have only one customer.</p>

<figure><div id="customers_tablecomma_table_9-8comma" class="figure"><img alt="The Customers table, Table 9-8, split into two tables" src="Images/pmj5_0901.png" width="1005" height="360"/>
<h6><span class="label">Figure 9-1. </span>The Customers table, <a data-type="xref" href="#third_normal_form_customers_table">Table 9-8</a>, split into two tables</h6>
</div></figure>

<p>Usually, when two items have a one-to-one relationship, you just include them as columns in the same table. There are two reasons for splitting them into separate tables:</p>

<ul>
	<li>
	<p>You want to be prepared in case the relationship changes later and is no longer one-to-one.</p>
	</li>
	<li>
	<p>The table has a lot of columns, and you think that performance or maintenance would be improved by splitting it.</p>
	</li>
</ul>

<p>Of course, when you build your own databases in the real world, you will have to create one-to-many Customer–Address relationships (<em>one</em> address, <em>many</em> customers).</p>
</div></section>

<section data-type="sect2" data-pdf-bookmark="One-to-Many"><div class="sect2" id="one-to-many">
<h2>One-to-Many</h2>

<p><em>One-to-many</em> (or many-to-one)<a contenteditable="false" data-primary="relationships, in databases" data-secondary="one-to-many" data-type="indexterm" id="idm45310005212056"/><a contenteditable="false" data-primary="one-to-many relationship" data-type="indexterm" id="idm45310005210584"/> relationships occur when one row in one table is linked to many rows in another table. You have already seen how <a data-type="xref" href="#third_normal_form_customers_table">Table 9-8</a> would take on a one-to-many relationship if multiple customers were allowed at the same address, which is why it would have to be split up if that were the case.</p>

<p>So, looking at Table 9-8a within <a data-type="xref" href="#customers_tablecomma_table_9-8comma">Figure 9-1</a>, you can see that it shares a one-to-many relationship with <a data-type="xref" href="#new_purchases_table">Table 9-7</a> because there is only one of each customer in Table 9-8a. However <a data-type="xref" href="#new_purchases_table">Table 9-7</a>, the <em>Purchases</em> table, can (and does) contain more than one purchase from a given customer. Therefore, <em>one</em> customer has a relationship with <em>many</em> purchases.</p>

<p>You can see these two tables alongside each other in <a data-type="xref" href="#illustrating_the_relationship_between_tw">Figure 9-2</a>, where the dashed lines joining rows in each table start from a single row in the lefthand table but can connect to more than one row in the righthand table. This one-to-many relationship is also the preferred scheme to use when describing a many-to-one relationship, in which case you would normally swap the left and right tables to view them as a one-to-many relationship.</p>

<figure><div id="illustrating_the_relationship_between_tw" class="figure"><img alt="Illustrating the relationship between two tables" src="Images/pmj5_0902.png" width="1068" height="422"/>
<h6><span class="label">Figure 9-2. </span>Illustrating the relationship between two tables</h6>
</div></figure>

<p>To represent a one-to-many relationship in a relational database, create a table for the “many” and a table for the “one.” The table for the “many” must contain a column that lists the primary key from the “one” table. Thus, the <em>Purchases</em> table will contain a column that lists the primary key of the customer.</p>
</div></section>

<section data-type="sect2" data-pdf-bookmark="Many-to-Many"><div class="sect2" id="many-to-many">
<h2>Many-to-Many</h2>

<p>In a <em>many-to-many relationship</em>, many<a contenteditable="false" data-primary="relationships, in databases" data-secondary="many-to-many" data-type="indexterm" id="idm45310005195656"/><a contenteditable="false" data-primary="many-to-many relationship" data-type="indexterm" id="idm45310005194264"/> rows in one table are linked to many rows in another table. To create this relationship, add a third table containing the same key column from each of the other tables. This third table contains nothing else, as its sole purpose is to link up the other tables.</p>

<p><a data-type="xref" href="#intermediary_table">Table 9-12</a> is just such a table. It was extracted from <a data-type="xref" href="#new_purchases_table">Table 9-7</a>, the <em>Purchases</em> table, but omits the purchase date information. It contains a copy of the ISBN of every title sold, along with the customer number of each purchaser.</p>

<table id="intermediary_table">
	<caption class="width-full"><span class="label">Table 9-12. </span>An intermediary table</caption>
	<thead>
		<tr>
			<th>Cust No</th>
			<th>ISBN</th>
		</tr>
	</thead>
	<tbody>
		<tr>
			<td>1</td>
			<td>0596101015</td>
		</tr>
		<tr>
			<td>2</td>
			<td>0596527403</td>
		</tr>
		<tr>
			<td>2</td>
			<td>0596101015</td>
		</tr>
		<tr>
			<td>3</td>
			<td>0596005436</td>
		</tr>
		<tr>
			<td>4</td>
			<td>0596006815</td>
		</tr>
	</tbody>
</table>

<p>With this intermediary table in place, you can traverse all the information in the database through a series of relations. You can take an address as a starting point and find out the authors of any books purchased by the customer living at that address.</p>

<p>For example, let’s suppose that you want to find out about purchases in the 23219 zip code. Look that zip code up in Table 9-8b, and you’ll find that customer number 2 has bought at least one item from the database. At this point, you can use Table 9-8a to find out that customer’s name, or use the new intermediary <a data-type="xref" href="#intermediary_table">Table 9-12</a> to see the book(s) purchased.</p>

<p>From here, you will find that two titles were purchased and can follow them back to <a data-type="xref" href="#new_titles_table">Table 9-4</a> to find the titles and prices of these books, or to <a data-type="xref" href="#new_authors_table">Table 9-3</a> to see who the authors were.</p>

<p>If it seems to you that this is really combining multiple one-to-many relationships, then you are absolutely correct. To illustrate, <a data-type="xref" href="#creating_a_many-to-many_relationship_via">Figure 9-3</a> brings three tables together.</p>

<figure><div id="creating_a_many-to-many_relationship_via" class="figure"><img alt="Creating a many-to-many relationship via a third table" src="Images/pmj5_0903.png" width="1193" height="502"/>
<h6><span class="label">Figure 9-3. </span>Creating a many-to-many relationship via a third table</h6>
</div></figure>

<p>Follow any zip code in the lefthand table to the associated customer IDs. From there, you can link to the middle table, which joins the left and right tables by linking customer IDs and ISBNs. Now all you have to do is follow an ISBN over to the righthand table to see which book it relates to.</p>

<p>You can also use the intermediary table to work your way backward from book titles to zip codes. The <em>Titles</em> table can tell you the ISBN, which you can use in the middle table to find the ID numbers of customers who bought the book, and finally you can use the <em>Customers</em> table to match the customer ID numbers to the customers’ zip codes.</p>
</div></section>

<section data-type="sect2" data-pdf-bookmark="Databases and Anonymity"><div class="sect2" id="databases_and_anonymity">
<h2>Databases and Anonymity</h2>

<p>An<a contenteditable="false" data-primary="MySQL" data-secondary="anonymity and" data-type="indexterm" id="idm45310005166920"/><a contenteditable="false" data-primary="databases" data-secondary="anonymity and" data-type="indexterm" id="idm45310005165512"/> interesting aspect of using relations is that you can accumulate a lot of information about some item—such as a customer—without actually knowing who that customer is. Note that in the previous example we went from customers’ zip codes to customers’ purchases, and back again, without finding out the name of a customer. Databases can be used to track people, but they can also be used to help preserve people’s privacy while still finding useful information.<a contenteditable="false" data-primary="" data-startref="MSQrelat09" data-type="indexterm" id="idm45310005163528"/><a contenteditable="false" data-primary="" data-startref="DBrelat09" data-type="indexterm" id="idm45310005162152"/></p>
</div></section>
</div></section>

<section data-type="sect1" data-pdf-bookmark="Transactions"><div class="sect1" id="transactions">
<h1>Transactions</h1>

<p>In<a contenteditable="false" data-primary="MySQL" data-secondary="transactions in" data-type="indexterm" id="MSQtrans09"/><a contenteditable="false" data-primary="databases" data-secondary="transactions in" data-type="indexterm" id="DBtrans09"/> some applications, it is vitally important that a sequence of queries runs in the correct order and that every single query successfully completes. For example, suppose that you are creating a sequence of queries to transfer funds from one bank account to another. You would not want either of the following events to occur:</p>

<ul>
	<li>
	<p>You add the funds to the second account, but when you try to subtract them from the first account, the update fails, and now both accounts have the funds.</p>
	</li>
	<li>
	<p>You subtract the funds from the first bank account, but the update request to add them to the second account fails, and the funds have disappeared into thin air.</p>
	</li>
</ul>

<p>As you can see, not only is the order of queries important in this type of transaction, but it is also vital that all parts of the transaction complete successfully. But how can you ensure this happens, because surely after a query has occurred, it cannot be undone? Do you have to keep track of all parts of a transaction and then undo them all one at a time if any one fails? The answer is absolutely not, because MySQL comes with powerful transaction-handling features to cover just these types of eventualities.</p>

<p>In addition, transactions allow concurrent access to a database by many users or programs at the same time. MySQL handles this seamlessly by ensuring that all transactions are queued and that users or programs take their turns and don’t tread on each other’s toes.</p>

<section data-type="sect2" data-pdf-bookmark="Transaction Storage Engines"><div class="sect2" id="transaction_storage_engines">
<h2>Transaction Storage Engines</h2>

<p>To<a contenteditable="false" data-primary="MySQL" data-secondary="default storage engine for" data-type="indexterm" id="idm45310005148616"/> be able to use MySQL’s transaction facility, you have to be using MySQL’s InnoDB storage engine (which is the default from version 5.5 onward). If you are not sure which version of MySQL your code will be running on, rather than assuming InnoDB is the default engine you can force its use when creating a table, as follows.</p>

<p>Create a table of bank accounts by typing the commands in <a data-type="xref" href="#creating_a_transaction-ready_table">Example 9-1</a>. (Remember that to do this, you will need access to the MySQL command line, and must also have already selected a suitable database in which to create this table.)</p>

<div data-type="example" id="creating_a_transaction-ready_table">
<h5><span class="label">Example 9-1. </span>Creating a transaction-ready table</h5>

<pre data-code-language="sql" data-programming-language="perl">
<code class="k">CREATE</code> <code class="k">TABLE</code> <code class="n">accounts</code> <code class="p">(</code>
 <code class="nb">number</code> <code class="nb">INT</code><code class="p">,</code> <code class="n">balance</code> <code class="nb">FLOAT</code><code class="p">,</code> <code class="k">PRIMARY</code> <code class="k">KEY</code><code class="p">(</code><code class="nb">number</code><code class="p">)</code>
 <code class="p">)</code> <code class="n">ENGINE</code> <code class="n">InnoDB</code><code class="p">;</code>
<code class="k">DESCRIBE</code> <code class="n">accounts</code><code class="p">;</code></pre>
</div>

<p>The final line of this example displays the contents of the new table so you can ensure that it was correctly created. The output from it should look like this:</p>

<pre data-programming-language="perl">
<strong>+---------+---------+------+-----+---------+-------+
| Field   | Type    | Null | Key | Default | Extra |
+---------+---------+------+-----+---------+-------+
| number  | int(11) | NO   | PRI | 0       |       |
| balance | float   | YES  |     | NULL    |       |
+---------+---------+------+-----+---------+-------+
2 rows in set (0.00 sec)</strong></pre>

<p>Now let’s create two rows within the table so that you can practice using transactions. Type the commands in <a data-type="xref" href="#populating_the_accounts_table">Example 9-2</a>.</p>

<div data-type="example" id="populating_the_accounts_table">
<h5><span class="label">Example 9-2. </span>Populating the accounts table</h5>

<pre data-code-language="sql" data-programming-language="perl">
<strong><code class="k">INSERT</code><code> </code><code class="k">INTO</code><code> </code><code class="n">accounts</code><code class="p">(</code><code class="nb">number</code><code class="p">,</code><code> </code><code class="n">balance</code><code class="p">)</code><code> </code><code class="k">VALUES</code><code class="p">(</code><code class="mi">12345</code><code class="p">,</code><code> </code><code class="mi">1025</code><code class="p">.</code><code class="mi">50</code><code class="p">)</code><code class="p">;</code><code>
</code><code class="k">INSERT</code><code> </code><code class="k">INTO</code><code> </code><code class="n">accounts</code><code class="p">(</code><code class="nb">number</code><code class="p">,</code><code> </code><code class="n">balance</code><code class="p">)</code><code> </code><code class="k">VALUES</code><code class="p">(</code><code class="mi">67890</code><code class="p">,</code><code> </code><code class="mi">140</code><code class="p">.</code><code class="mi">00</code><code class="p">)</code><code class="p">;</code><code>
</code><code class="k">SELECT</code><code> </code><code class="o">*</code><code> </code><code class="k">FROM</code><code> </code><code class="n">accounts</code><code class="p">;</code></strong></pre>
</div>

<p>The third line displays the contents of the table to confirm that the rows were correctly inserted. The output should look like this:</p>

<pre data-programming-language="perl">
<strong>+--------+---------+
| number | balance |
+--------+---------+
|  12345 |  1025.5 |
|  67890 |     140 |
+--------+---------+
2 rows in set (0.00 sec)</strong></pre>

<p>With this table created and prepopulated, you are ready to start using transactions.</p>
</div></section>

<section data-type="sect2" data-pdf-bookmark="Using BEGIN"><div class="sect2" id="using_begin">
<h2>Using BEGIN</h2>

<p>Transactions<a contenteditable="false" data-primary="BEGIN statement (MySQL)" data-type="indexterm" id="idm45310005031688"/><a contenteditable="false" data-primary="START TRANSACTION statement (MySQL)" data-type="indexterm" id="idm45310005030552"/> in MySQL start with either a <code>BEGIN</code> or a <code>START TRANSACTION</code> statement. Type the commands in <a data-type="xref" href="#mysql_transaction">Example 9-3</a> to send a transaction to MySQL.</p>

<div data-type="example" id="mysql_transaction">
<h5><span class="label">Example 9-3. </span>A MySQL transaction</h5>

<pre data-code-language="sql" data-programming-language="perl">
<code class="k">BEGIN</code><code class="p">;</code>
<code class="k">UPDATE</code> <code class="n">accounts</code> <code class="k">SET</code> <code class="n">balance</code><code class="o">=</code><code class="n">balance</code><code class="o">+</code><code class="mi">25</code><code class="p">.</code><code class="mi">11</code> <code class="k">WHERE</code> <code class="nb">number</code><code class="o">=</code><code class="mi">12345</code><code class="p">;</code>
<code class="k">COMMIT</code><code class="p">;</code>
<code class="k">SELECT</code> <code class="o">*</code> <code class="k">FROM</code> <code class="n">accounts</code><code class="p">;</code></pre>
</div>

<p>The result of this transaction is displayed by the final line, and should look like this:</p>

<pre data-programming-language="perl">
<strong>+--------+---------+
| number | balance |
+--------+---------+
|  12345 | 1050.61 |
|  67890 |     140 |
+--------+---------+
2 rows in set (0.00 sec)</strong></pre>

<p>As you can see, the balance of account number 12345 was increased by 25.11 and is now 1050.61. You may also have noticed the <code>COMMIT</code> command in <a data-type="xref" href="#mysql_transaction">Example 9-3</a>, which is explained next.</p>
</div></section>

<section data-type="sect2" data-pdf-bookmark="Using COMMIT"><div class="sect2" id="using_commit">
<h2>Using COMMIT</h2>

<p>When<a contenteditable="false" data-primary="COMMIT command (MySQL)" data-type="indexterm" id="idm45310004978136"/> you are satisfied that a series of queries in a transaction has successfully completed, issue a <code>COMMIT</code> command to commit all the changes to the database. Until it receives a <code>COMMIT</code>, MySQL considers all the changes you make to be merely temporary. This feature gives you the opportunity to cancel a transaction by not sending a <code>COMMIT</code> but issuing a <code>ROLLBACK</code> command instead.</p>
</div></section>

<section data-type="sect2" data-pdf-bookmark="Using ROLLBACK"><div class="sect2" id="using_rollback">
<h2>Using ROLLBACK</h2>

<p>Using<a contenteditable="false" data-primary="ROLLBACK command (MySQL)" data-type="indexterm" id="idm45310004972744"/> the <code>ROLLBACK</code> command, you can tell MySQL to forget all the queries made since the start of a transaction and to cancel the transaction. See this in action by entering the funds transfer transaction in <a data-type="xref" href="#funds_transfer_transaction">Example 9-4</a>.</p>

<div data-type="example" id="funds_transfer_transaction">
<h5><span class="label">Example 9-4. </span>A funds transfer transaction</h5>

<pre data-code-language="sql" data-programming-language="perl">
<code class="k">BEGIN</code><code class="p">;</code>
<code class="k">UPDATE</code> <code class="n">accounts</code> <code class="k">SET</code> <code class="n">balance</code><code class="o">=</code><code class="n">balance</code><code class="o">-</code><code class="mi">250</code> <code class="k">WHERE</code> <code class="nb">number</code><code class="o">=</code><code class="mi">12345</code><code class="p">;</code>
<code class="k">UPDATE</code> <code class="n">accounts</code> <code class="k">SET</code> <code class="n">balance</code><code class="o">=</code><code class="n">balance</code><code class="o">+</code><code class="mi">250</code> <code class="k">WHERE</code> <code class="nb">number</code><code class="o">=</code><code class="mi">67890</code><code class="p">;</code>
<code class="k">SELECT</code> <code class="o">*</code> <code class="k">FROM</code> <code class="n">accounts</code><code class="p">;</code></pre>
</div>

<p>Once you have entered these lines, you should see the following result:</p>

<pre data-programming-language="perl">
<strong>+--------+---------+
| number | balance |
+--------+---------+
|  12345 |  800.61 |
|  67890 |     390 |
+--------+---------+
2 rows in set (0.00 sec)</strong></pre>

<p>The first bank account now has a value that is 250 less than before, and the second has been incremented by 250; you have transferred a value of 250 between them. But let’s assume that something went wrong and you wish to undo this transaction. All you have to do is issue the commands in <a data-type="xref" href="#canceling_a_transaction_using_rollback">Example 9-5</a>.</p>

<div data-type="example" id="canceling_a_transaction_using_rollback">
<h5><span class="label">Example 9-5. </span>Canceling a transaction using ROLLBACK</h5>

<pre data-code-language="sql" data-programming-language="perl">
<code class="k">ROLLBACK</code><code class="p">;</code>
<code class="k">SELECT</code> <code class="o">*</code> <code class="k">FROM</code> <code class="n">accounts</code><code class="p">;</code></pre>
</div>

<p>You should now see the following output, showing that the two accounts have had their previous balances restored, due to the entire transaction being cancelled via the <code>ROLLBACK</code> command:</p>

<pre data-programming-language="perl">
<strong>+--------+---------+
| number | balance |
+--------+---------+
|  12345 | 1050.61 |
|  67890 |     140 |
+--------+---------+
2 rows in set (0.00 sec)</strong></pre>
</div></section>
</div></section>

<section data-type="sect1" data-pdf-bookmark="Using EXPLAIN"><div class="sect1" id="using_explain">
<h1>Using EXPLAIN</h1>

<p>MySQL<a contenteditable="false" data-primary="MySQL" data-secondary="EXPLAIN command" data-type="indexterm" id="idm45310004898136"/><a contenteditable="false" data-primary="EXPLAIN command (MySQL)" data-type="indexterm" id="idm45310004896728"/> comes with a powerful tool for investigating how the queries you issue to it are interpreted. Using <code>EXPLAIN</code>, you can get a snapshot of any query to find out whether you could issue it in a better or more efficient way. <a data-type="xref" href="#using_the_explain_command">Example 9-6</a> shows how to use it with the <em>accounts</em> table you created earlier.</p>

<div data-type="example" id="using_the_explain_command">
<h5><span class="label">Example 9-6. </span>Using the EXPLAIN command</h5>

<pre data-code-language="sql" data-programming-language="perl">
<code class="k">EXPLAIN</code> <code class="k">SELECT</code> <code class="o">*</code> <code class="k">FROM</code> <code class="n">accounts</code> <code class="k">WHERE</code> <code class="nb">number</code><code class="o">=</code><code class="s1">'12345'</code><code class="p">;</code></pre>
</div>

<p>The results of this <code>EXPLAIN</code> command should look like the following:</p>

<pre data-programming-language="perl">
<strong>+----+-------------+----------+------------+-------+---------------+---------+---------+-------+------+----------+-------+
| id | select_type | table    | partitions | type  | possible_keys | key     | key_len | ref   | rows | filtered | Extra |
+----+-------------+----------+------------+-------+---------------+---------+---------+-------+------+----------+-------+
|  1 | SIMPLE      | accounts | NULL       | const | PRIMARY       | PRIMARY | 4       | const |    1 |   100.00 | NULL  |
+----+-------------+----------+------------+-------+---------------+---------+---------+-------+------+----------+-------+
</strong><strong>1 row in set (0.00 sec)</strong></pre>

<p>The information that MySQL is giving you here is as follows:</p>

<dl>
	<dt><dfn><code>select_type</code></dfn></dt>
	<dd>
	<p>The selection type is <code>SIMPLE</code>. If you were joining tables together, this would show the join type.</p>
	</dd>
	<dt><dfn><code>table</code></dfn></dt>
	<dd>
	<p>The current table being queried is <code>accounts</code>.</p>
	</dd>
	<dt><dfn><code>type</code></dfn></dt>
	<dd>
	<p>The query type is <code>const</code>. From the least efficient to the most efficient type, the possible values can be <code>ALL</code>, <code>index</code>, <code>range</code>, <code>ref</code>, <code>eq</code><em>_</em><code>ref</code>, <code>const</code>, <code>system</code>, and <code>NULL</code>.</p>
	</dd>
	<dt><dfn><code>possible_keys</code></dfn></dt>
	<dd>
	<p>There is a possible <code>PRIMARY</code> key, which means that accessing should be fast.</p>
	</dd>
	<dt><dfn><code>key</code></dfn></dt>
	<dd>
	<p>The key actually used is <code>PRIMARY</code>. This is good.</p>
	</dd>
	<dt><dfn><code>key_len</code></dfn></dt>
	<dd>
	<p>The key length is <code>4</code>. This is the number of bytes of the index that MySQL will use.</p>
	</dd>
	<dt><dfn><code>ref</code></dfn></dt>
	<dd>
	<p>The <code>ref</code> column displays which columns or constants are used with the key. In this case, a constant key is being used.</p>
	</dd>
	<dt><dfn><code>rows</code></dfn></dt>
	<dd>
	<p>The number of rows that need to be searched by this query is <code>1</code>. This is good.</p>
	</dd>
</dl>

<p>Whenever you have a query that seems to be taking longer than you think it should to execute, try using <code>EXPLAIN</code> to see where you can optimize it. You will discover which keys (if any) are being used, their lengths, and so on, and will be able to adjust your query or the design of your table(s) accordingly.<a contenteditable="false" data-primary="" data-startref="MSQtrans09" data-type="indexterm" id="idm45310004784456"/><a contenteditable="false" data-primary="" data-startref="DBtrans09" data-type="indexterm" id="idm45310004783080"/></p>

<div data-type="note" epub:type="note"><h6>Note</h6>
<p>When you have finished experimenting with the temporary <em>accounts</em> table, you may wish to remove it by entering the following command:</p>

<pre data-code-language="sql" data-programming-language="perl">
<code class="k">DROP</code> <code class="k">TABLE</code> <code class="n">accounts</code><code class="p">;</code></pre>
</div>
</div></section>

<section data-type="sect1" data-pdf-bookmark="Backing Up and Restoring"><div class="sect1" id="backing_up_and_restoring">
<h1>Backing Up and Restoring</h1>

<p>Whatever<a contenteditable="false" data-primary="MySQL" data-secondary="backup and restore in" data-type="indexterm" id="MSQback09"/><a contenteditable="false" data-primary="databases" data-secondary="backup and restore for" data-type="indexterm" id="DBback09"/> kind of data you are storing in your database, it must have some value to you, even if it’s only the cost of the time required for reentering it should the hard disk fail. Therefore, it’s important that you keep backups to protect your investment. Also, there will be times when you have to migrate your database over to a new server; the best way to do this is usually to back it up first. It is also important that you test your backups from time to time to ensure that they are valid and will work if they need to be used.</p>

<p>Thankfully, backing up and restoring MySQL data is easy with the <code>mysqldump</code> command.</p>

<section data-type="sect2" data-pdf-bookmark="Using mysqldump"><div class="sect2" id="using_mysqldump">
<h2>Using mysqldump</h2>

<p>With <code>mysqldump</code>, you can dump<a contenteditable="false" data-primary="mysqldump command" data-type="indexterm" id="mdump09"/><a contenteditable="false" data-primary="tables" data-secondary="backup and restore" data-type="indexterm" id="idm45310004768728"/><a contenteditable="false" data-primary="MySQL" data-secondary="tables, backup and restore" data-type="indexterm" id="MSQtablback09"/> a database or collection of databases into one or more files containing all the instructions necessary to re-create all your tables and repopulate them with your data. This command can also generate files in <em>CSV</em> (comma-separated values) and other delimited text formats, or even in XML format. Its main drawback is that you must make sure that no one writes to a table while you’re backing it up. There are various ways to do this, but the easiest is to shut down the MySQL server before running <code>mysqldump</code> and start up the server again after <code>mysqldump</code> finishes.</p>

<p>Alternatively, you can lock the tables you are backing up before running <code>mysqldump</code>. To lock tables for reading (as we want to read the data), from the MySQL command line issue this command:</p>

<pre data-code-language="sql" data-programming-language="perl">
<code class="k">LOCK</code><code> </code><code class="n">TABLES</code><code> </code><em><code class="n">tablename1</code></em><code> </code><code class="k">READ</code><code class="p">,</code><code> </code><em><code class="n">tablename2</code></em><code> </code><code class="k">READ</code><code> </code><code class="p">.</code><code class="p">.</code><code class="p">.</code></pre>

<p>Then, to release the lock(s), enter the following:</p>

<pre data-code-language="sql" data-programming-language="perl">
<code class="n">UNLOCK</code> <code class="n">TABLES</code><code class="p">;</code></pre>

<p>By default, the output from <code>mysqldump</code> is simply printed out, but you can capture it in a file through the <code>&gt;</code> redirect symbol.</p>

<p>The basic format of the <code>mysqldump</code> command is shown here:</p>

<pre data-programming-language="perl">
mysqldump -u <em>user</em> -p<em>password database</em></pre>

<p>However, before you can dump the contents of a database, you must make sure that <code>mysqldump</code> is in your path, or else specify its location as part of your command. <a data-type="xref" href="#likely_locations_of_mysqldump_for_differ">Table 9-13</a> shows the likely locations of the program for the different installations and operating systems covered in <a data-type="xref" href="ch02.xhtml#setting_up_a_development_server">Chapter 2</a>. If you have a different installation, it may be in a slightly different location.</p>

<table id="likely_locations_of_mysqldump_for_differ">
	<caption class="width-full"><span class="label">Table 9-13. </span>Likely locations of mysqldump for different installations</caption>
	<thead>
		<tr>
			<th>Operating system and program</th>
			<th>Likely folder location</th>
		</tr>
	</thead>
	<tbody>
		<tr>
			<td>Windows AMPPS</td>
			<td><em>C:\Program Files\Ampps\mysql\bin</em></td>
		</tr>
		<tr>
			<td>macOS AMPPS</td>
			<td><em>/Applications/ampps/mysql/bin</em></td>
		</tr>
		<tr>
			<td>Linux AMPPS</td>
			<td><em>/Applications/ampps/mysql/bin</em></td>
		</tr>
	</tbody>
</table>

<p>So, to dump the contents of the <em>publications</em> database that you created in <a data-type="xref" href="ch08.xhtml#introduction_to_mysql">Chapter 8</a> to the screen, first exit MySQL and then enter the command in <a data-type="xref" href="#dumping_the_publications_database_to_scr">Example 9-7</a> (specifying the full path to <code>mysqldump</code> if necessary).</p>

<div data-type="example" id="dumping_the_publications_database_to_scr">
<h5><span class="label">Example 9-7. </span>Dumping the publications database to screen</h5>

<pre data-programming-language="perl">
mysqldump -u <em>user</em> -p<em>password</em> publications</pre>
</div>

<p>Make sure that you replace <em><code>user</code></em> and <em><code>password</code></em> with the correct details for your installation of MySQL. If there is no password set for the user, you can omit that part of the command, but the <code>-u</code> <em><code>user</code></em> part is mandatory unless you have root access without a password and are executing as root (not recommended). The result of issuing this command will look something like <a data-type="xref" href="#dumping_the_publications_databas-id00028">Figure 9-4</a>.</p>

<figure><div id="dumping_the_publications_databas-id00028" class="figure"><img alt="Dumping the publications database to the screen" src="Images/pmj5_0904.png" width="669" height="332"/>
<h6><span class="label">Figure 9-4. </span>Dumping the publications database to the screen</h6>
</div></figure>
</div></section>

<section data-type="sect2" data-pdf-bookmark="Creating a Backup File"><div class="sect2" id="creating_a_backup_file">
<h2>Creating a Backup File</h2>

<p>Now that you have <code>mysqldump</code> working, and have verified it outputs correctly to the screen, you can send the backup data directly to a file using the <code>&gt;</code> redirect symbol. Assuming that you wish to call the backup file <em>publications.sql</em>, type the command in <a data-type="xref" href="#dumping_the_publications_database_to_fil">Example 9-8</a> (remembering to replace <em><code>user</code></em> and <em><code>password</code></em> with the correct details).</p>

<div data-type="example" id="dumping_the_publications_database_to_fil">
<h5><span class="label">Example 9-8. </span>Dumping the publications database to a file</h5>

<pre data-programming-language="perl">
mysqldump -u <em>user</em> –p <em>password</em> publications &gt; publications.sql</pre>
</div>

<div data-type="note" epub:type="note"><h6>Note</h6>
<p>The command in <a data-type="xref" href="#dumping_the_publications_database_to_fil">Example 9-8</a> stores the backup file into the current directory. If you need it to be saved elsewhere, you should insert a file path before the filename. You must also ensure that the directory you are backing up to has the right permissions set to allow the file to be written.</p>
</div>

<p>If you echo the backup file to screen or load it into a text editor, you will see that it comprises sequences of SQL commands such as the following:</p>

<pre data-code-language="sql" data-programming-language="perl">
<code class="k">DROP</code> <code class="k">TABLE</code> <code class="n">IF</code> <code class="k">EXISTS</code> <code class="s1">'classics'</code><code class="p">;</code>
<code class="k">CREATE</code> <code class="k">TABLE</code> <code class="s1">'classics'</code> <code class="p">(</code>
  <code class="s1">'author'</code> <code class="nb">varchar</code><code class="p">(</code><code class="mi">128</code><code class="p">)</code> <code class="k">default</code> <code class="k">NULL</code><code class="p">,</code>
  <code class="s1">'title'</code> <code class="nb">varchar</code><code class="p">(</code><code class="mi">128</code><code class="p">)</code> <code class="k">default</code> <code class="k">NULL</code><code class="p">,</code>
  <code class="s1">'category'</code> <code class="nb">varchar</code><code class="p">(</code><code class="mi">16</code><code class="p">)</code> <code class="k">default</code> <code class="k">NULL</code><code class="p">,</code>
  <code class="s1">'year'</code> <code class="nb">smallint</code><code class="p">(</code><code class="mi">6</code><code class="p">)</code> <code class="k">default</code> <code class="k">NULL</code><code class="p">,</code>
  <code class="s1">'isbn'</code> <code class="nb">char</code><code class="p">(</code><code class="mi">13</code><code class="p">)</code> <code class="k">NOT</code> <code class="k">NULL</code> <code class="k">default</code> <code class="s1">''</code><code class="p">,</code>
  <code class="k">PRIMARY</code> <code class="k">KEY</code>  <code class="p">(</code><code class="s1">'isbn'</code><code class="p">),</code>
  <code class="k">KEY</code> <code class="s1">'author'</code> <code class="p">(</code><code class="s1">'author'</code><code class="p">(</code><code class="mi">20</code><code class="p">)),</code>
  <code class="k">KEY</code> <code class="s1">'title'</code> <code class="p">(</code><code class="s1">'title'</code><code class="p">(</code><code class="mi">20</code><code class="p">)),</code>
  <code class="k">KEY</code> <code class="s1">'category'</code> <code class="p">(</code><code class="s1">'category'</code><code class="p">(</code><code class="mi">4</code><code class="p">)),</code>
  <code class="k">KEY</code> <code class="s1">'year'</code> <code class="p">(</code><code class="s1">'year'</code><code class="p">),</code>
  <code class="n">FULLTEXT</code> <code class="k">KEY</code> <code class="s1">'author_2'</code> <code class="p">(</code><code class="s1">'author'</code><code class="p">,</code><code class="s1">'title'</code><code class="p">)</code>
<code class="p">)</code> <code class="n">ENGINE</code><code class="o">=</code><code class="n">InnoDB</code> <code class="k">DEFAULT</code> <code class="n">CHARSET</code><code class="o">=</code><code class="n">latin1</code><code class="p">;</code></pre>

<p>This is smart code that can be used to restore a database from a backup, even if it currently exists; it will first drop any tables that need to be re-created, thus avoiding potential MySQL errors.</p>

<section data-type="sect3" data-pdf-bookmark="Backing up a single table"><div class="sect3" id="backing_up_a_single_table">
<h3>Backing up a single table</h3>

<p>To back up only a single table from a database (such as the <em>classics</em> table from the <em>publications</em> database), you should first lock the table from within the MySQL command line, by issuing a command such as the following:</p>

<pre data-code-language="sql" data-programming-language="perl">
<code class="k">LOCK</code> <code class="n">TABLES</code> <code class="n">publications</code><code class="p">.</code><code class="n">classics</code> <code class="k">READ</code><code class="p">;</code></pre>

<p>This ensures that MySQL remains running for read purposes, but writes cannot be made. Then, while keeping the MySQL command line open, use another terminal window to issue the following command from the operating system command line:</p>

<pre data-programming-language="perl">
mysqldump -u <em>user</em> -p<em>password</em> publications classics &gt; classics.sql</pre>

<p>You must now release the table lock by entering the following command from the MySQL command line in the first terminal window, which unlocks all tables that have been locked during the current session:</p>

<pre data-code-language="sql" data-programming-language="perl">
<code class="n">UNLOCK</code> <code class="n">TABLES</code><code class="p">;</code></pre>
</div></section>

<section data-type="sect3" data-pdf-bookmark="Backing up all tables"><div class="sect3" id="backing_up_all_tables">
<h3>Backing up all tables</h3>

<p>If you want to back up all your MySQL databases at once (including the system databases such as <em>mysql</em>), you can use a command such as the one in <a data-type="xref" href="#dumping_all_the_mysql_databases_to_file">Example 9-9</a>, which would enable you to restore an entire MySQL database installation. Remember to use locking where required.</p>

<div data-type="example" id="dumping_all_the_mysql_databases_to_file">
<h5><span class="label">Example 9-9. </span>Dumping all the MySQL databases to file</h5>

<pre data-programming-language="perl">
mysqldump -u <em>user</em> -p<em>password</em> --all-databases &gt; all_databases.sql</pre>
</div>

<div data-type="note" epub:type="note"><h6>Note</h6>
<p>Of course, there’s a lot more than just a few lines of SQL code in backed-up database files. I recommend that you take a few minutes to examine a couple in order to familiarize yourself with the types of commands that appear in backup files and how they work.</p>
</div>
</div></section>
</div></section>

<section data-type="sect2" data-pdf-bookmark="Restoring from a Backup File"><div class="sect2" id="restoring_from_a_backup_file">
<h2>Restoring from a Backup File</h2>

<p>To perform a restore from a file, call the <em>mysql</em> executable, passing it the file to restore from using the <code>&lt;</code> symbol. So, to recover an entire database that you dumped using the <code>--all-databases</code> option, use a command such as that in <a data-type="xref" href="#restoring_an_entire_set_of_databases">Example 9-10</a>.</p>

<div data-type="example" id="restoring_an_entire_set_of_databases">
<h5><span class="label">Example 9-10. </span>Restoring an entire set of databases</h5>

<pre data-programming-language="perl">
mysql -u <em>user</em> -p<em>password</em> &lt; all_databases.sql</pre>
</div>

<p>To restore a single database, use the <code>-D</code> option followed by the name of the database, as in <a data-type="xref" href="#restoring_the_publications_database">Example 9-11</a>, where the <em>publications</em> database is being restored from the backup made in <a data-type="xref" href="#dumping_the_publications_database_to_fil">Example 9-8</a>.</p>

<div data-type="example" id="restoring_the_publications_database">
<h5><span class="label">Example 9-11. </span>Restoring the publications database</h5>

<pre data-programming-language="perl">
mysql -u <em>user</em> -p<em>password</em> -D publications &lt; publications.sql</pre>
</div>

<p>To restore a single table to a database, use a command such as that in <a data-type="xref" href="#restoring_the_classics_table_to_the_publ">Example 9-12</a>, where just the <em>classics</em> table is being restored to the <em>publications</em> database.</p>

<div data-type="example" id="restoring_the_classics_table_to_the_publ">
<h5><span class="label">Example 9-12. </span>Restoring the classics table to the publications database</h5>

<pre data-programming-language="perl">
mysql -u <em>user</em> -p<em>password</em> -D publications &lt; classics.sql</pre>
</div>
</div></section>

<section data-type="sect2" data-pdf-bookmark="Dumping Data in CSV Format"><div class="sect2" id="dumping_data_in_csv_format">
<h2>Dumping Data in CSV Format</h2>

<p>As<a contenteditable="false" data-primary="CSV format, dumping data in" data-type="indexterm" id="idm45310004406776"/> previously mentioned, the <code>mysqldump</code> program is very flexible and supports various types of output, such as the CSV format, which you might use to import data into a spreadsheet, among other purposes. <a data-type="xref" href="#dumping_data_to_csv_format_files">Example 9-13</a> shows how you can dump the data from the <em>classics</em> and <em>customers</em> tables in the <em>publications</em> database to the files <em>classics.txt</em> and <em>customers.txt</em> in the folder <em>c:/temp</em>. On macOS or Linux systems, you should modify the destination path to an existing folder.</p>

<div data-type="example" id="dumping_data_to_csv_format_files">
<h5><span class="label">Example 9-13. </span>Dumping data to CSV-format files</h5>

<pre data-programming-language="perl">
mysqldump -u <em>user</em> -p<em>password</em> --no-create-info --tab=c:/temp
  --fields-terminated-by=',' publications</pre>
</div>

<p>This command is quite long and is shown here wrapped over two lines, but you must type it all as a single line. The result is the following:</p>

<pre data-programming-language="perl">
<strong>Mark Twain (Samuel Langhorne Clemens)','The Adventures of Tom Sawyer',
 'Classic Fiction','1876','9781598184891
Jane Austen','Pride and Prejudice','Classic Fiction','1811','9780582506206
Charles Darwin','The Origin of Species','Non-Fiction','1856','9780517123201
Charles Dickens','The Old Curiosity Shop','Classic Fiction','1841','9780099533474
William Shakespeare','Romeo and Juliet','Play','1594','9780192814968

Mary Smith','9780582506206
Jack Wilson','9780517123201</strong></pre>
</div></section>

<section data-type="sect2" data-pdf-bookmark="Planning Your Backups"><div class="sect2" id="planning_your_backups">
<h2>Planning Your Backups</h2>

<p>The golden rule to backing up is to do so as often as you find practical. The more valuable the data, the more often you should back it up, and the more copies you should make. If your database gets updated at least once a day, you should really back it up on a daily basis. If, on the other hand, it is not updated very often, you could probably get by with less frequent backups.</p>

<div data-type="note" epub:type="note"><h6>Note</h6>
<p>You should consider making multiple backups and storing them in different locations. If you have several servers, it is a simple matter to copy your backups between them. You would also be well advised to make physical backups on removable hard disks, thumb drives, CDs or DVDs, and so on, and to keep these in separate locations—preferably somewhere like a fireproof safe.</p>

<p>It’s important to test restoring a database once in a while, too, to make sure your backups are done correctly. You also want to be familiar with restoring a database because you may have to do so when you are stressed and in a hurry, such as after a power failure that takes down the website. You can restore a database to a private server and run a few SQL commands to make sure the data is as you think it should be.</p>
</div>

<p>Once you’ve digested the contents of this chapter, you will be proficient in using both PHP and MySQL; the next chapter will show you how to bring these two technologies together.<a contenteditable="false" data-primary="" data-startref="MSQback09" data-type="indexterm" id="idm45310004391320"/><a contenteditable="false" data-primary="" data-startref="DBback09" data-type="indexterm" id="idm45310004389944"/><a contenteditable="false" data-primary="" data-startref="mdump09" data-type="indexterm" id="idm45310004388568"/><a contenteditable="false" data-primary="" data-startref="MSQtablback09" data-type="indexterm" id="idm45310004387192"/></p>
</div></section>
</div></section>

<section data-type="sect1" data-pdf-bookmark="Questions"><div class="sect1" id="questions-id00029">
<h1>Questions</h1>

<ol>
	<li>
	<p>What does the word <em>relationship</em> mean in reference to a relational database?</p>
	</li>
	<li>
	<p>What is the term for the process of removing duplicate data and optimizing tables?</p>
	</li>
	<li>
	<p>What are the three rules of the First Normal Form?</p>
	</li>
	<li>
	<p>How can you make a table satisfy the Second Normal Form?</p>
	</li>
	<li>
	<p>What do you put in a column to tie together two tables that contain items having a one-to-many relationship?</p>
	</li>
	<li>
	<p>How can you create a database with a many-to-many relationship?</p>
	</li>
	<li>
	<p>What commands initiate and end a MySQL transaction?</p>
	</li>
	<li>
	<p>What feature does MySQL provide to enable you to examine how a query will work in detail?</p>
	</li>
	<li>
	<p>What command would you use to back up the database <em>publications</em> to a file called <em>publications.sql</em>?</p>
	</li>
</ol>

<p>See <a data-type="xref" href="app01.xhtml#chapter_9_answers">“Chapter 9 Answers”</a> in <a data-type="xref" href="app01.xhtml#solutions_to_the_chapter_questions">Appendix A</a> for the answers to these <span class="keep-together">questions</span>.</p>
</div></section>
</div></section></div></body>
</html>